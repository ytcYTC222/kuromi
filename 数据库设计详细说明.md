# 数据库设计详细说明

## 📊 数据库概览

### 基本信息
- **数据库名称**: `database_design`
- **数据库引擎**: MySQL 8.0+
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`
- **总表数**: 19个核心业务表

### 表分类统计
- **用户相关**: 4个表 (users, user_addresses, user_favorites, user_browse_history)
- **商品相关**: 6个表 (products, product_images, categories, product_reviews, product_recommendations, product_tags)
- **订单相关**: 3个表 (orders, order_items, shopping_cart)
- **营销相关**: 3个表 (banners, coupons, promotions)
- **系统相关**: 3个表 (hot_searches, operation_logs, system_config)

## 🏗️ 核心表结构

### 1. 用户管理模块

#### users - 用户基本信息表
```sql
CREATE TABLE `users` (
  `user_id` int NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `openid` varchar(100) UNIQUE COMMENT '微信OpenID',
  `unionid` varchar(100) COMMENT '微信UnionID',
  `phone` varchar(20) UNIQUE COMMENT '手机号',
  `password` varchar(255) COMMENT '密码hash',
  `nickname` varchar(50) COMMENT '昵称',
  `avatar_url` varchar(500) COMMENT '头像URL',
  `real_name` varchar(50) COMMENT '真实姓名',
  `gender` tinyint DEFAULT 0 COMMENT '性别：0未知，1男，2女',
  `birthday` date COMMENT '生日',
  `registration_source` varchar(50) COMMENT '注册来源',
  `registration_date` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
  `last_login_time` timestamp COMMENT '最后登录时间',
  `login_count` int DEFAULT 0 COMMENT '登录次数',
  `status` tinyint DEFAULT 1 COMMENT '状态：0禁用，1启用，2待激活',
  `vip_level` tinyint DEFAULT 0 COMMENT 'VIP等级',
  `total_consumption` decimal(10,2) DEFAULT 0.00 COMMENT '累计消费金额',
  `total_orders` int DEFAULT 0 COMMENT '累计订单数',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP,
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `openid` (`openid`),
  UNIQUE KEY `phone` (`phone`),
  KEY `idx_status` (`status`),
  KEY `idx_registration_date` (`registration_date`)
) COMMENT = '用户表';
```

#### user_addresses - 用户地址表
```sql
CREATE TABLE `user_addresses` (
  `address_id` int NOT NULL AUTO_INCREMENT COMMENT '地址ID',
  `user_id` int NOT NULL COMMENT '用户ID',
  `contact_name` varchar(50) NOT NULL COMMENT '联系人姓名',
  `contact_phone` varchar(20) NOT NULL COMMENT '联系电话',
  `province` varchar(50) NOT NULL COMMENT '省份',
  `city` varchar(50) NOT NULL COMMENT '城市',
  `district` varchar(50) NOT NULL COMMENT '区县',
  `detailed_address` varchar(200) NOT NULL COMMENT '详细地址',
  `postal_code` varchar(10) COMMENT '邮政编码',
  `latitude` decimal(10,7) COMMENT '纬度',
  `longitude` decimal(10,7) COMMENT '经度',
  `is_default` tinyint DEFAULT 0 COMMENT '是否默认地址：0否，1是',
  `address_type` tinyint DEFAULT 1 COMMENT '地址类型：1家庭，2公司，3学校，4其他',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`address_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_is_default` (`is_default`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`user_id`) ON DELETE CASCADE
) COMMENT = '用户地址表';
```

### 2. 商品管理模块

#### categories - 商品分类表
```sql
CREATE TABLE `categories` (
  `category_id` int NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `category_name` varchar(50) NOT NULL COMMENT '分类名称',
  `category_code` varchar(50) NOT NULL COMMENT '分类编码',
  `parent_id` int DEFAULT 0 COMMENT '父分类ID，0表示顶级分类',
  `category_level` tinyint DEFAULT 1 COMMENT '分类层级',
  `sort_order` int DEFAULT 0 COMMENT '排序权重',
  `category_image` varchar(500) COMMENT '分类图片',
  `category_icon` varchar(500) COMMENT '分类图标',
  `description` text COMMENT '分类描述',
  `seo_title` varchar(100) COMMENT 'SEO标题',
  `seo_keywords` varchar(200) COMMENT 'SEO关键词',
  `seo_description` varchar(500) COMMENT 'SEO描述',
  `is_active` tinyint DEFAULT 1 COMMENT '是否启用：0禁用，1启用',
  `is_hot` tinyint DEFAULT 0 COMMENT '是否热门分类：0否，1是',
  `product_count` int DEFAULT 0 COMMENT '商品数量',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`category_id`),
  UNIQUE KEY `category_code` (`category_code`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_category_level` (`category_level`),
  KEY `idx_sort_order` (`sort_order`),
  KEY `idx_is_active` (`is_active`)
) COMMENT = '商品分类表';
```

#### products - 商品基本信息表
```sql
CREATE TABLE `products` (
  `product_id` int NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `product_name` varchar(200) NOT NULL COMMENT '商品名称',
  `product_code` varchar(100) UNIQUE COMMENT '商品编码',
  `category_id` int NOT NULL COMMENT '分类ID',
  `brand` varchar(100) COMMENT '品牌',
  `description` text COMMENT '商品描述',
  `short_description` varchar(500) COMMENT '商品简介',
  `material` varchar(100) COMMENT '材质',
  `color` varchar(50) COMMENT '颜色',
  `size` varchar(100) COMMENT '尺寸',
  `weight` decimal(10,2) COMMENT '重量(kg)',
  `original_price` decimal(10,2) NOT NULL COMMENT '原价',
  `current_price` decimal(10,2) NOT NULL COMMENT '现价',
  `cost_price` decimal(10,2) COMMENT '成本价',
  `stock_quantity` int DEFAULT 0 COMMENT '库存数量',
  `stock_warning` int DEFAULT 10 COMMENT '库存预警值',
  `sales_count` int DEFAULT 0 COMMENT '销售数量',
  `view_count` int DEFAULT 0 COMMENT '浏览次数',
  `favorite_count` int DEFAULT 0 COMMENT '收藏次数',
  `rating_average` decimal(3,2) DEFAULT 0.00 COMMENT '平均评分',
  `rating_count` int DEFAULT 0 COMMENT '评价数量',
  `is_hot` tinyint DEFAULT 0 COMMENT '是否热门：0否，1是',
  `is_new` tinyint DEFAULT 0 COMMENT '是否新品：0否，1是',
  `is_featured` tinyint DEFAULT 0 COMMENT '是否精选：0否，1是',
  `is_promotion` tinyint DEFAULT 0 COMMENT '是否促销：0否，1是',
  `promotion_price` decimal(10,2) COMMENT '促销价格',
  `promotion_start_time` timestamp COMMENT '促销开始时间',
  `promotion_end_time` timestamp COMMENT '促销结束时间',
  `status` tinyint DEFAULT 1 COMMENT '状态：0下架，1上架，2待审核',
  `seo_title` varchar(100) COMMENT 'SEO标题',
  `seo_keywords` varchar(200) COMMENT 'SEO关键词',
  `seo_description` varchar(500) COMMENT 'SEO描述',
  `supplier_id` int COMMENT '供应商ID',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`product_id`),
  UNIQUE KEY `product_code` (`product_code`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_brand` (`brand`),
  KEY `idx_status` (`status`),
  KEY `idx_is_hot` (`is_hot`),
  KEY `idx_is_new` (`is_new`),
  KEY `idx_current_price` (`current_price`),
  KEY `idx_sales_count` (`sales_count`),
  KEY `idx_create_time` (`create_time`),
  FOREIGN KEY (`category_id`) REFERENCES `categories`(`category_id`)
) COMMENT = '商品表';
```

### 3. 订单管理模块

#### orders - 订单主表
```sql
CREATE TABLE `orders` (
  `order_id` int NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_number` varchar(50) NOT NULL UNIQUE COMMENT '订单号',
  `user_id` int NOT NULL COMMENT '用户ID',
  `total_amount` decimal(10,2) NOT NULL COMMENT '订单总金额',
  `discount_amount` decimal(10,2) DEFAULT 0.00 COMMENT '优惠金额',
  `coupon_discount` decimal(10,2) DEFAULT 0.00 COMMENT '优惠券优惠',
  `shipping_fee` decimal(10,2) DEFAULT 0.00 COMMENT '运费',
  `final_amount` decimal(10,2) NOT NULL COMMENT '实付金额',
  `order_status` tinyint DEFAULT 1 COMMENT '订单状态：1待付款，2已付款，3已发货，4已收货，5已完成，6已取消，7退款中，8已退款',
  `payment_method` varchar(50) COMMENT '支付方式',
  `payment_status` tinyint DEFAULT 0 COMMENT '支付状态：0未支付，1已支付，2支付失败',
  `payment_time` timestamp COMMENT '支付时间',
  `payment_transaction_id` varchar(100) COMMENT '支付交易号',
  `shipping_method` varchar(50) COMMENT '配送方式',
  `shipping_time` timestamp COMMENT '发货时间',
  `shipping_code` varchar(100) COMMENT '快递单号',
  `shipping_company` varchar(50) COMMENT '快递公司',
  `delivery_time` timestamp COMMENT '收货时间',
  `completion_time` timestamp COMMENT '完成时间',
  `cancel_time` timestamp COMMENT '取消时间',
  `cancel_reason` varchar(200) COMMENT '取消原因',
  `refund_amount` decimal(10,2) DEFAULT 0.00 COMMENT '退款金额',
  `refund_reason` varchar(200) COMMENT '退款原因',
  `refund_time` timestamp COMMENT '退款时间',
  `shipping_address` text NOT NULL COMMENT '收货地址信息JSON',
  `order_notes` text COMMENT '订单备注',
  `seller_notes` text COMMENT '商家备注',
  `invoice_type` tinyint DEFAULT 0 COMMENT '发票类型：0不开票，1普通发票，2增值税发票',
  `invoice_title` varchar(100) COMMENT '发票抬头',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`order_id`),
  UNIQUE KEY `order_number` (`order_number`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_order_status` (`order_status`),
  KEY `idx_payment_status` (`payment_status`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_payment_time` (`payment_time`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`user_id`)
) COMMENT = '订单表';
```

### 4. 营销管理模块

#### promotions - 促销活动表
```sql
CREATE TABLE `promotions` (
  `promotion_id` int NOT NULL AUTO_INCREMENT COMMENT '促销ID',
  `promotion_name` varchar(100) NOT NULL COMMENT '促销名称',
  `promotion_type` tinyint NOT NULL COMMENT '促销类型：1满减，2折扣，3买N送M，4限时抢购',
  `description` text COMMENT '促销描述',
  `promotion_rule` text NOT NULL COMMENT '促销规则JSON',
  `target_type` tinyint DEFAULT 1 COMMENT '目标类型：1全场，2分类，3商品',
  `target_value` text COMMENT '目标值JSON',
  `start_time` timestamp NOT NULL COMMENT '开始时间',
  `end_time` timestamp NOT NULL COMMENT '结束时间',
  `status` tinyint DEFAULT 1 COMMENT '状态：0禁用，1启用，2已结束',
  `priority` int DEFAULT 0 COMMENT '优先级',
  `usage_limit` int COMMENT '使用次数限制',
  `used_count` int DEFAULT 0 COMMENT '已使用次数',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`promotion_id`),
  KEY `idx_promotion_type` (`promotion_type`),
  KEY `idx_status` (`status`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) COMMENT = '促销活动表';
```

## 🔗 表关系设计

### 主要外键关系
```sql
-- 用户地址关联用户
ALTER TABLE user_addresses ADD FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE;

-- 商品关联分类
ALTER TABLE products ADD FOREIGN KEY (category_id) REFERENCES categories(category_id);

-- 订单关联用户
ALTER TABLE orders ADD FOREIGN KEY (user_id) REFERENCES users(user_id);

-- 订单项关联订单和商品
ALTER TABLE order_items ADD FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE;
ALTER TABLE order_items ADD FOREIGN KEY (product_id) REFERENCES products(product_id);

-- 购物车关联用户和商品
ALTER TABLE shopping_cart ADD FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE;
ALTER TABLE shopping_cart ADD FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE;

-- 收藏关联用户和商品
ALTER TABLE user_favorites ADD FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE;
ALTER TABLE user_favorites ADD FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE;
```

### 数据完整性约束
1. **级联删除**: 用户删除时同时删除其地址、购物车、收藏等数据
2. **外键约束**: 确保数据引用完整性
3. **唯一约束**: 防止重复数据（如用户手机号、商品编码等）
4. **检查约束**: 确保数据有效性（如价格大于0、状态值在有效范围内）

## 📈 索引设计策略

### 主要索引
1. **主键索引**: 所有表的主键自动创建聚集索引
2. **唯一索引**: 用户手机号、商品编码、订单号等
3. **外键索引**: 所有外键字段创建索引
4. **查询索引**: 根据常用查询条件创建组合索引
5. **排序索引**: 常用排序字段创建索引

### 性能优化索引
```sql
-- 商品查询优化
CREATE INDEX idx_products_category_status ON products(category_id, status);
CREATE INDEX idx_products_price_range ON products(current_price, status);
CREATE INDEX idx_products_hot_new ON products(is_hot, is_new, status);

-- 订单查询优化
CREATE INDEX idx_orders_user_status ON orders(user_id, order_status);
CREATE INDEX idx_orders_time_status ON orders(create_time, order_status);

-- 用户行为优化
CREATE INDEX idx_user_favorites_user_time ON user_favorites(user_id, favorite_time);
CREATE INDEX idx_shopping_cart_user_selected ON shopping_cart(user_id, is_selected);
```

## 🛡️ 数据安全设计

### 1. 敏感数据处理
- **密码加密**: 使用bcrypt进行密码hash
- **手机号脱敏**: 查询时部分隐藏
- **支付信息**: 不存储完整支付信息，仅保留必要的交易号

### 2. 数据备份策略
- **定期备份**: 每日自动备份数据库
- **增量备份**: 重要操作后进行增量备份
- **异地备份**: 关键数据异地存储

### 3. 访问控制
- **读写分离**: 查询和写入使用不同的数据库连接
- **权限控制**: 不同角色具有不同的数据访问权限
- **SQL注入防护**: 使用参数化查询

## 📊 数据统计字段

### 冗余字段设计
为了提高查询性能，在相关表中增加了统计字段：

1. **users表**: total_consumption(累计消费), total_orders(累计订单数)
2. **categories表**: product_count(商品数量)
3. **products表**: sales_count(销售数量), favorite_count(收藏次数), view_count(浏览次数)

### 定时更新机制
```sql
-- 更新商品销售数量
UPDATE products p SET sales_count = (
  SELECT COALESCE(SUM(oi.quantity), 0) 
  FROM order_items oi 
  JOIN orders o ON oi.order_id = o.order_id 
  WHERE oi.product_id = p.product_id AND o.order_status >= 2
);

-- 更新分类商品数量
UPDATE categories c SET product_count = (
  SELECT COUNT(*) FROM products p 
  WHERE p.category_id = c.category_id AND p.status = 1
);
```

这种数据库设计确保了：
- **高性能**: 通过合理的索引和冗余字段提升查询速度
- **高可用**: 通过外键约束保证数据一致性
- **可扩展**: 预留了扩展字段便于后续功能升级
- **安全性**: 敏感数据加密存储，访问权限控制