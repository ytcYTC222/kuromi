<!-- ç»“ç®—é¡µé¢ -->
<view class="page-container">
  <!-- æ”¶è´§åœ°å€ -->
  <view class="address-section">
    <view class="section-header" bindtap="selectAddress">
      <view class="address-icon">ğŸ“</view>
      <view class="address-content" wx:if="{{selectedAddress}}">
        <view class="address-info">
          <text class="receiver-name">{{selectedAddress.receiver_name}}</text>
          <text class="receiver-phone">{{selectedAddress.receiver_phone}}</text>
        </view>
        <view class="address-detail">{{selectedAddress.province}} {{selectedAddress.city}} {{selectedAddress.district}} {{selectedAddress.detail_address}}</view>
      </view>
      <view class="address-content" wx:else>
        <view class="no-address">
          <text class="no-address-text">è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
        </view>
      </view>
      <view class="arrow-right">></view>
    </view>
  </view>

  <!-- å•†å“åˆ—è¡¨ -->
  <view class="goods-section">
    <view class="section-title">
      <text class="store-icon">ğŸª</text>
      <text class="store-name">ç°ä»£å®¶å±…</text>
    </view>
    <view class="goods-list">
      <block wx:for="{{orderItems}}" wx:key="id">
        <view class="goods-item">
          <image src="{{item.image}}" class="goods-image" mode="aspectFill"></image>
          <view class="goods-info">
            <view class="goods-title">{{item.title}}</view>
            <view class="goods-attributes" wx:if="{{item.attributes}}">{{item.attributes}}</view>
            <view class="goods-price-row">
              <view class="goods-price">Â¥{{item.price}}</view>
              <view class="goods-quantity">x{{item.quantity}}</view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸ -->
  <view class="coupon-section" bindtap="selectCoupon">
    <view class="coupon-header">
      <view class="coupon-icon">ğŸ«</view>
      <view class="coupon-content">
        <text class="coupon-title">ä¼˜æƒ åˆ¸</text>
        <text class="coupon-desc" wx:if="{{selectedCoupon}}">å·²é€‰æ‹©ï¼š{{selectedCoupon.coupon_name}}</text>
        <text class="coupon-desc" wx:else>{{availableCoupons.length}}å¼ å¯ç”¨</text>
      </view>
      <view class="coupon-discount" wx:if="{{selectedCoupon}}">
        <text class="discount-amount">-Â¥{{couponDiscount}}</text>
      </view>
      <view class="arrow-right">></view>
    </view>
  </view>

  <!-- é…é€æ–¹å¼ -->
  <view class="delivery-section">
    <view class="delivery-header">
      <view class="delivery-icon">ğŸšš</view>
      <view class="delivery-content">
        <text class="delivery-title">é…é€æ–¹å¼</text>
        <text class="delivery-desc">{{deliveryMethod.name}}</text>
      </view>
      <view class="delivery-fee">
        <text class="fee-amount" wx:if="{{shippingFee > 0}}">Â¥{{shippingFee}}</text>
        <text class="fee-free" wx:else>å…é‚®</text>
      </view>
    </view>
  </view>

  <!-- æ”¯ä»˜æ–¹å¼ -->
  <view class="payment-section">
    <view class="payment-header">
      <view class="payment-icon">ğŸ’³</view>
      <view class="payment-content">
        <text class="payment-title">æ”¯ä»˜æ–¹å¼</text>
        <text class="payment-desc">å¾®ä¿¡æ”¯ä»˜</text>
      </view>
      <view class="payment-status">
        <text class="status-text">å®‰å…¨æ”¯ä»˜</text>
      </view>
    </view>
  </view>

  <!-- è®¢å•å¤‡æ³¨ -->
  <view class="remark-section">
    <view class="remark-header">
      <view class="remark-icon">ğŸ“</view>
      <text class="remark-title">è®¢å•å¤‡æ³¨</text>
    </view>
    <textarea 
      class="remark-input" 
      placeholder="é€‰å¡«ï¼Œè¯·è¾“å…¥æ‚¨çš„éœ€æ±‚" 
      value="{{orderRemark}}"
      bindinput="onRemarkInput"
      maxlength="200">
    </textarea>
  </view>

  <!-- è´¹ç”¨æ˜ç»† -->
  <view class="cost-section">
    <view class="cost-item">
      <text class="cost-label">å•†å“æ€»ä»·</text>
      <text class="cost-value">Â¥{{totalAmount}}</text>
    </view>
    <view class="cost-item" wx:if="{{couponDiscount > 0}}">
      <text class="cost-label">ä¼˜æƒ åˆ¸</text>
      <text class="cost-value discount">-Â¥{{couponDiscount}}</text>
    </view>
    <view class="cost-item">
      <text class="cost-label">è¿è´¹</text>
      <text class="cost-value" wx:if="{{shippingFee > 0}}">Â¥{{shippingFee}}</text>
      <text class="cost-value free" wx:else>å…é‚®</text>
    </view>
  </view>

  <!-- åº•éƒ¨ç»“ç®—æ  -->
  <view class="checkout-footer">
    <view class="total-info">
      <view class="total-label">å®ä»˜æ¬¾ï¼š</view>
      <view class="total-amount">Â¥{{actualAmount}}</view>
    </view>
    <button class="submit-button" bindtap="submitOrder" disabled="{{!selectedAddress || submitting}}">
      <text wx:if="{{submitting}}">æäº¤ä¸­...</text>
      <text wx:else>æäº¤è®¢å•</text>
    </button>
  </view>
</view>

<!-- åœ°å€é€‰æ‹©å¼¹çª— -->
<view class="address-modal" wx:if="{{showAddressModal}}">
  <view class="modal-mask" bindtap="closeAddressModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©æ”¶è´§åœ°å€</text>
      <view class="modal-close" bindtap="closeAddressModal">Ã—</view>
    </view>
    <view class="address-list">
      <block wx:for="{{userAddresses}}" wx:key="address_id">
        <view class="address-item {{selectedAddress && selectedAddress.address_id === item.address_id ? 'selected' : ''}}" 
              bindtap="selectAddressItem" data-address="{{item}}">
          <view class="address-item-content">
            <view class="address-item-info">
              <text class="item-receiver">{{item.receiver_name}}</text>
              <text class="item-phone">{{item.receiver_phone}}</text>
              <text class="default-tag" wx:if="{{item.is_default}}">é»˜è®¤</text>
            </view>
            <view class="item-address">{{item.province}} {{item.city}} {{item.district}} {{item.detail_address}}</view>
          </view>
          <view class="address-item-check" wx:if="{{selectedAddress && selectedAddress.address_id === item.address_id}}">
            âœ“
          </view>
        </view>
      </block>
      <view class="add-address-btn" bindtap="addNewAddress">
        <text class="add-icon">+</text>
        <text class="add-text">æ–°å¢æ”¶è´§åœ°å€</text>
      </view>
    </view>
  </view>
</view>

<!-- ä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª— -->
<view class="coupon-modal" wx:if="{{showCouponModal}}">
  <view class="modal-mask" bindtap="closeCouponModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©ä¼˜æƒ åˆ¸</text>
      <view class="modal-close" bindtap="closeCouponModal">Ã—</view>
    </view>
    <view class="coupon-list">
      <view class="coupon-item no-coupon {{!selectedCoupon ? 'selected' : ''}}" 
            bindtap="selectCouponItem" data-coupon="{{null}}">
        <view class="coupon-item-content">
          <text class="coupon-item-title">ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
        </view>
        <view class="coupon-item-check" wx:if="{{!selectedCoupon}}">
          âœ“
        </view>
      </view>
      <block wx:for="{{availableCoupons}}" wx:key="coupon_id">
        <view class="coupon-item {{selectedCoupon && selectedCoupon.coupon_id === item.coupon_id ? 'selected' : ''}}" 
              bindtap="selectCouponItem" data-coupon="{{item}}">
          <view class="coupon-item-content">
            <view class="coupon-item-info">
              <text class="coupon-item-title">{{item.coupon_name}}</text>
              <text class="coupon-item-desc">æ»¡{{item.min_amount}}å…ƒå¯ç”¨</text>
            </view>
            <view class="coupon-item-value">
              <text class="coupon-value">Â¥{{item.discount_value}}</text>
            </view>
          </view>
          <view class="coupon-item-check" wx:if="{{selectedCoupon && selectedCoupon.coupon_id === item.coupon_id}}">
            âœ“
          </view>
        </view>
      </block>
    </view>
  </view>
</view>

<!-- åŠ è½½é®ç½© -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>