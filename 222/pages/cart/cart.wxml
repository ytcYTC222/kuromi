<!-- è´­ç‰©è½¦é¡µé¢ -->
<view class="page-container">
  <!-- è´­ç‰©è½¦æ ‡é¢˜ -->
  <view class="cart-header">
    <view class="container">
      <view class="section-header">
        <view class="section-title">è´­ç‰©è½¦</view>
        <view class="section-description">ç®¡ç†æ‚¨çš„è´­ç‰©è½¦å¹¶å®Œæˆè®¢å•</view>
      </view>
    </view>
  </view>

  <!-- è´­ç‰©è½¦å†…å®¹ -->
  <view class="cart-content">
    <view class="container">
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-container" wx:if="{{loading}}">
        <view class="loading-text">åŠ è½½ä¸­...</view>
      </view>
      
      <!-- è´­ç‰©è½¦ä¸ºç©ºæ—¶æ˜¾ç¤º -->
      <view class="empty-cart" wx:elif="{{!cartItems || cartItems.length === 0}}">
        <image src="/img/empty-cart.png" class="empty-cart-image"></image>
        <view class="empty-cart-text">æ‚¨çš„è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„</view>
        <view class="empty-cart-subtext">æµè§ˆæˆ‘ä»¬çš„äº§å“å¹¶æ·»åŠ åˆ°è´­ç‰©è½¦</view>
        <button class="primary-button" bindtap="goToProducts">
          å»é€‰è´­
        </button>
      </view>

      <!-- è´­ç‰©è½¦æœ‰å•†å“æ—¶æ˜¾ç¤º -->
      <block wx:else>
        <!-- è´­ç‰©è½¦åˆ—è¡¨ -->
        <view class="cart-list">
          <block wx:for="{{cartItems}}" wx:key="id">
            <view class="cart-item">
              <view class="cart-item-checkbox">
                <checkbox checked="{{item.checked}}" bindtap="toggleItemCheck" data-id="{{item.id}}"></checkbox>
              </view>
              <view class="cart-item-image">
                <image 
                  src="{{item.image}}" 
                  mode="aspectFill"
                  lazy-load="true"
                  show-menu-by-longpress="true"
                  binderror="onImageError"
                  bindload="onImageLoad"
                  data-id="{{item.id}}"
                  class="product-image"
                ></image>
                <view class="image-overlay" wx:if="{{item.imageLoading}}">
                  <view class="loading-spinner-small"></view>
                </view>
                <view class="image-placeholder" wx:if="{{item.imageError}}">
                  <text class="placeholder-icon">ğŸ“·</text>
                  <text class="placeholder-text">å›¾ç‰‡åŠ è½½å¤±è´¥</text>
                </view>
              </view>
              <view class="cart-item-info">
                <view class="cart-item-title">{{item.title}}</view>
                <view class="cart-item-attributes" wx:if="{{item.attributes}}">
                  <text>{{item.attributes}}</text>
                </view>
                <view class="cart-item-price-row">
                  <view class="cart-item-price">Â¥{{item.price}}</view>
                  <view class="quantity-control">
                    <view class="quantity-button" catchtap="decreaseQuantity" data-id="{{item.id}}">-</view>
                    <view class="quantity-number">{{item.quantity}}</view>
                    <view class="quantity-button" catchtap="increaseQuantity" data-id="{{item.id}}">+</view>
                  </view>
                </view>
              </view>
              <view class="cart-item-delete" catchtap="deleteItem" data-id="{{item.id}}">
                <text>ğŸ—‘ï¸</text>
              </view>
            </view>
          </block>
        </view>

        <!-- è´­ç‰©è½¦åº•éƒ¨ -->
        <view class="cart-footer">
          <view class="cart-total">
            <view class="select-all">
              <checkbox checked="{{selectAll}}" bindtap="toggleSelectAll"></checkbox>
              <text>å…¨é€‰</text>
            </view>
            <view class="total-price">
              <text>åˆè®¡ï¼š</text>
              <text class="total-amount">Â¥{{totalPrice}}</text>
            </view>
          </view>
          <button class="checkout-button" bindtap="checkout">
            å»ç»“ç®— ({{selectedCount}})
          </button>
        </view>
        
        <!-- çŒœä½ å–œæ¬¢ -->
        <view class="recommendations">
          <view class="recommendation-header">
            <view class="section-title">ğŸ›ï¸ çŒœä½ å–œæ¬¢</view>
            <view class="section-subtitle">çƒ­é—¨å•†å“æ¨è</view>
            <view class="refresh-btn" bindtap="refreshRecommendations" wx:if="{{!loadingRecommendations}}">
              <text class="refresh-icon">ğŸ”„</text>
              <text class="refresh-text">æ¢ä¸€æ‰¹</text>
            </view>
          </view>
          
          <!-- åŠ è½½çŠ¶æ€ -->
          <view wx:if="{{loadingRecommendations}}" class="loading-recommendations">
            <view class="loading-spinner"></view>
            <view class="loading-text">æ­£åœ¨ä¸ºæ‚¨æ¨èå•†å“...</view>
          </view>
          
          <!-- æ¨èå•†å“åˆ—è¡¨ -->
          <view wx:elif="{{recommendedProducts && recommendedProducts.length > 0}}" class="recommended-products">
            <block wx:for="{{recommendedProducts}}" wx:key="id">
              <view class="recommended-product" bindtap="navigateToProduct" data-id="{{item.id}}">
                <view class="product-badge" wx:if="{{item.originalPrice && item.originalPrice != item.price}}">
                  <text class="badge-text">ç‰¹æƒ </text>
                </view>
                <image src="{{item.image}}" class="recommended-image" mode="aspectFill" lazy-load="true"></image>
                <view class="recommended-info">
                  <view class="recommended-title">{{item.title}}</view>
                  <view class="recommended-category">{{item.categoryName}}</view>
                  <view class="recommended-rating" wx:if="{{item.rating > 0}}">
                    <view class="rating-stars">
                      <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="star">
                        <text class="star {{star <= item.rating ? 'star-filled' : 'star-empty'}}">â˜…</text>
                      </block>
                    </view>
                    <text class="rating-score">{{item.rating}}</text>
                    <text class="rating-count">({{item.ratingCount}})</text>
                  </view>
                  <view class="recommended-price">
                    <text class="current-price">Â¥{{item.price}}</text>
                    <text wx:if="{{item.originalPrice && item.originalPrice != item.price}}" class="original-price">Â¥{{item.originalPrice}}</text>
                  </view>
                  <view class="recommended-sales" wx:if="{{item.salesCount > 0}}">
                    <text class="sales-icon">ğŸ”¥</text>
                    <text>å·²å”®{{item.salesCount}}ä»¶</text>
                  </view>
                  <view class="add-to-cart-btn" catchtap="addToCartFromRecommendation" data-id="{{item.id}}">
                    <text class="cart-icon">ğŸ›’</text>
                    <text>åŠ å…¥è´­ç‰©è½¦</text>
                  </view>
                </view>
              </view>
            </block>
          </view>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view wx:else class="empty-recommendations">
            <view class="empty-icon">ğŸ“¦</view>
            <view class="empty-text">æš‚æ— æ¨èå•†å“</view>
            <view class="empty-subtext">ç¨åå†æ¥çœ‹çœ‹å§</view>
            <button class="retry-btn" bindtap="refreshRecommendations">é‡æ–°åŠ è½½</button>
          </view>
        </view>
      </block>
    </view>
  </view>
</view>